<!DOCTYPE html>
<html lang="nl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OV Vertrektijden</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --ns-yellow: #FFC917;
            --ns-blue: #003082;
            --bus-blue: #0066b3;
            --bus-orange: #f18700;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
        }

        .delayed {
            color: #e53e3e;
        }

        .cancelled {
            text-decoration: line-through;
            color: #718096;
        }

        .ns-yellow {
            background-color: var(--ns-yellow);
        }

        .ns-blue {
            background-color: var(--ns-blue);
            color: white;
        }

        .bus-blue {
            background-color: var(--bus-blue);
            color: white;
        }

        .bus-orange {
            background-color: var(--bus-orange);
            color: white;
        }

        .station-card {
            border-left: 4px solid var(--ns-yellow);
            transition: all 0.3s ease;
        }

        .busstop-card {
            border-left: 4px solid var(--bus-orange);
            transition: all 0.3s ease;
        }

        .station-card:hover,
        .busstop-card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transform: translateY(-2px);
        }

        .settings-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background-color: white;
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            transition: right 0.3s ease;
            overflow-y: auto;
        }

        .settings-panel.open {
            right: 0;
        }

        .settings-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }

        .settings-overlay.open {
            display: block;
        }

        .station-search,
        .busstop-search {
            position: relative;
        }

        .station-search input,
        .busstop-search input {
            padding-left: 2.5rem;
            width: 100%;
        }

        .station-search i,
        .busstop-search i {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: #718096;
        }

        .station-dropdown {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 0.375rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            display: none;
        }

        .busstop-dropdown {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 0.375rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            display: none;
            position: absolute;
            width: 100%;
            background-color: white;
            z-index: 10;
            margin-top: 2px;
        }

        .station-dropdown.open,
        .busstop-dropdown.open {
            display: block;
        }

        .station-item,
        .busstop-item {
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .station-item:hover,
        .busstop-item:hover {
            background-color: #f7fafc;
        }

        .selected-stations,
        .selected-busstops {
            max-height: 300px;
            overflow-y: auto;
        }

        .selected-station,
        .selected-busstop {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 1rem;
            margin-bottom: 0.5rem;
            background-color: #f7fafc;
            border-radius: 0.375rem;
        }

        .selected-station {
            border-left: 3px solid var(--ns-yellow);
        }

        .selected-busstop {
            border-left: 3px solid var(--bus-orange);
        }

        .selected-station button,
        .selected-busstop button {
            color: #e53e3e;
            background: none;
            border: none;
            cursor: pointer;
        }

        .settings-toggle {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 3.5rem;
            height: 3.5rem;
            border-radius: 50%;
            background-color: var(--ns-blue);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            z-index: 998;
            transition: transform 0.3s ease;
        }

        .settings-toggle:hover {
            transform: scale(1.1);
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid #e2e8f0;
            margin-bottom: 1rem;
        }

        .tab {
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 2px solid transparent;
        }

        .tab.active {
            border-bottom: 2px solid var(--ns-blue);
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Dark mode styles */
        body.dark-mode {
            background-color: #1a202c;
            color: #e2e8f0;
        }

        body.dark-mode .ns-yellow {
            background-color: #d4a100;
        }

        body.dark-mode .station-card,
        body.dark-mode .busstop-card,
        body.dark-mode .settings-panel {
            background-color: #2d3748;
            color: #e2e8f0;
        }

        body.dark-mode header {
            background-color: #6a4e02;
        }

        body.dark-mode header h1,
        body.dark-mode #clock {
            color: #f8fafc;
        }

        body.dark-mode .station-card .bg-blue-50,
        body.dark-mode .busstop-card .bg-orange-50 {
            background-color: #2c3e50;
            color: #f8fafc;
            border-color: #4a5568;
        }

        body.dark-mode .station-card h2,
        body.dark-mode .busstop-card h2 {
            color: #f8fafc;
        }

        body.dark-mode .responsive-table thead {
            background-color: #2c3e50;
            color: #f8fafc;
        }

        body.dark-mode .bus-orange {
            background-color: #b05500;
        }

        body.dark-mode .bg-blue-900 {
            background-color: #1e3a8a;
        }

        body.dark-mode tbody tr {
            border-color: #4a5568;
        }

        body.dark-mode tbody tr:hover {
            background-color: #3a4a5e !important;
        }

        body.dark-mode .selected-station,
        body.dark-mode .selected-busstop,
        body.dark-mode .station-item:hover,
        body.dark-mode .busstop-item:hover {
            background-color: #3a4a5e;
        }

        body.dark-mode .text-gray-500,
        body.dark-mode .text-gray-600,
        body.dark-mode .text-gray-700 {
            color: #a0aec0;
        }

        body.dark-mode .text-green-600 {
            color: #68d391;
        }

        body.dark-mode .text-red-600 {
            color: #fc8181;
        }

        body.dark-mode .text-yellow-600 {
            color: #fbd38d;
        }

        body.dark-mode .text-blue-900 {
            color: #90cdf4;
        }

        body.dark-mode .text-orange-800 {
            color: #fbd38d;
        }

        body.dark-mode .border-gray-300 {
            border-color: #4a5568;
        }

        body.dark-mode input,
        body.dark-mode select {
            background-color: #2d3748;
            color: #e2e8f0;
            border-color: #4a5568;
        }

        body.dark-mode input:focus {
            border-color: #63b3ed;
        }

        body.dark-mode input::placeholder {
            color: #718096;
        }

        body.dark-mode .station-dropdown,
        body.dark-mode .busstop-dropdown {
            background-color: #2d3748;
            border-color: #4a5568;
        }

        /* Responsive table styles */
        @media (max-width: 640px) {
            .responsive-table {
                display: block;
            }

            .responsive-table thead {
                display: none;
            }

            .responsive-table tbody {
                display: block;
            }

            .responsive-table tr {
                display: block;
                margin-bottom: 1rem;
                border: 1px solid #e2e8f0;
                border-radius: 0.5rem;
                padding: 0.5rem;
            }

            .responsive-table td {
                display: flex;
                padding: 0.5rem !important;
                border: none !important;
                align-items: center;
            }

            .responsive-table td::before {
                content: attr(data-label);
                font-weight: 600;
                margin-right: 1rem;
                min-width: 100px;
            }

            .settings-panel {
                width: 100%;
                right: -100%;
            }
        }
    </style>
</head>

<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-2 sm:p-4">
        <header class="flex items-center justify-between mb-4 sm:mb-6 ns-yellow p-3 sm:p-4 rounded-lg shadow-lg">
            <div class="flex items-center">
                <i class="fas fa-train text-blue-900 mr-2 text-xl"></i>
                <h1 class="text-lg sm:text-2xl font-bold text-blue-900">OV Vertrektijden</h1>
            </div>
            <div id="clock" class="text-base sm:text-xl font-mono text-blue-900 font-bold"></div>
        </header>

        <!-- Station Departures Container -->
        <div id="stations-container" class="grid grid-cols-1 gap-4 sm:gap-6">
            <!-- Train stations and bus stops will be dynamically added here -->
        </div>

        <div class="mt-4 text-right">
            <p class="text-xs sm:text-sm text-gray-600">Laatste update: <span id="last-update"></span></p>
        </div>
    </div>

    <!-- Settings Toggle Button -->
    <div class="settings-toggle" id="settings-toggle">
        <i class="fas fa-cog text-xl"></i>
    </div>

    <!-- Settings Overlay -->
    <div class="settings-overlay" id="settings-overlay"></div>

    <!-- Settings Panel -->
    <div class="settings-panel" id="settings-panel">
        <div class="p-4 ns-blue">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold">Instellingen</h2>
                <button id="close-settings" class="text-white hover:text-gray-200">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
        </div>
        <div class="p-4">
            <div class="tabs">
                <div class="tab active" data-tab="trains">Treinen</div>
                <div class="tab" data-tab="buses">Bussen</div>
                <div class="tab" data-tab="display">Weergave</div>
            </div>

            <div class="tab-content active" id="trains-tab">
                <h3 class="text-lg font-semibold mb-2">Treinstations</h3>
                <p class="text-sm text-gray-600 mb-4">Selecteer de stations waarvan je de vertrektijden wilt zien.</p>

                <!-- Station Search -->
                <div class="mb-4">
                    <label for="station-search" class="block text-sm font-medium text-gray-700 mb-1">Zoek
                        station</label>
                    <div class="station-search">
                        <i class="fas fa-search"></i>
                        <input type="text" id="station-search" placeholder="Typ om te zoeken..." autocomplete="off"
                            class="border border-gray-300 rounded-md py-2 px-4 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div class="station-dropdown mt-1" id="station-dropdown">
                        <!-- Station options will be populated here -->
                    </div>
                </div>

                <!-- Selected Stations -->
                <div class="mb-4">
                    <h4 class="text-md font-medium text-gray-700 mb-2">Geselecteerde stations</h4>
                    <div class="selected-stations" id="selected-stations">
                        <!-- Selected stations will be displayed here -->
                        <p id="no-stations-message" class="text-sm text-gray-500 italic">Geen stations geselecteerd</p>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="buses-tab">
                <h3 class="text-lg font-semibold mb-2">Bushaltes</h3>
                <p class="text-sm text-gray-600 mb-4">Selecteer de bushaltes waarvan je de vertrektijden wilt zien.</p>

                <!-- Bus Stop Search -->
                <div class="mb-4">
                    <label for="busstop-search" class="block text-sm font-medium text-gray-700 mb-1">Zoek
                        bushalte</label>
                    <div class="busstop-search relative">
                        <i class="fas fa-search"></i>
                        <input type="text" id="busstop-search" placeholder="Bushaltes worden geladen..." disabled
                            autocomplete="off"
                            class="border border-gray-300 rounded-md py-2 px-4 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <!-- Loading indicator will be added here dynamically -->
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Typ minimaal 2 karakters om te zoeken</p>
                    <div class="busstop-dropdown mt-1" id="busstop-dropdown">
                        <!-- Bus stop options will be populated here -->
                    </div>
                </div>

                <!-- Selected Bus Stops -->
                <div class="mb-4">
                    <h4 class="text-md font-medium text-gray-700 mb-2">Geselecteerde bushaltes</h4>
                    <div class="selected-busstops" id="selected-busstops">
                        <!-- Selected bus stops will be displayed here -->
                        <p id="no-busstops-message" class="text-sm text-gray-500 italic">Geen bushaltes geselecteerd</p>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="display-tab">
                <!-- Display Settings -->
                <h3 class="text-lg font-semibold mb-2">Weergave-instellingen</h3>
                <div class="mb-2">
                    <label for="num-departures" class="block text-sm font-medium text-gray-700 mb-1">Aantal
                        vertrektijden per station/halte</label>
                    <input type="number" id="num-departures" min="1" max="20" value="9" autocomplete="off"
                        class="border border-gray-300 rounded-md py-2 px-4 w-full focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div class="mb-2">
                    <label for="refresh-interval" class="block text-sm font-medium text-gray-700 mb-1">Ververs interval
                        (seconden)</label>
                    <input type="number" id="refresh-interval" min="10" max="300" value="30" autocomplete="off"
                        class="border border-gray-300 rounded-md py-2 px-4 w-full focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div class="flex items-center mb-2">
                    <input type="checkbox" id="dark-mode" class="mr-2">
                    <label for="dark-mode" class="text-sm font-medium text-gray-700">Donkere modus</label>
                </div>
            </div>

            <!-- Save Button -->
            <button id="save-settings"
                class="w-full py-2 px-4 bg-blue-900 text-white rounded-md hover:bg-blue-800 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition-colors">
                Instellingen opslaan
            </button>
        </div>
    </div>

    <script>
        // Global variables
        const DEFAULT_DEPARTURES = 9;
        let numDepartures = DEFAULT_DEPARTURES;
        let refreshInterval = 30; // seconds
        let selectedStations = [];
        let selectedBusStops = [];
        let allStations = [];
        let allBusStops = [];
        let refreshTimer;
        let busStopsLoaded = false; // Track if bus stops have been loaded

        // DOM Elements
        const settingsToggle = document.getElementById('settings-toggle');
        const settingsPanel = document.getElementById('settings-panel');
        const settingsOverlay = document.getElementById('settings-overlay');
        const closeSettings = document.getElementById('close-settings');
        const stationSearch = document.getElementById('station-search');
        const stationDropdown = document.getElementById('station-dropdown');
        const selectedStationsContainer = document.getElementById('selected-stations');
        const noStationsMessage = document.getElementById('no-stations-message');
        const busStopSearch = document.getElementById('busstop-search');
        const busStopDropdown = document.getElementById('busstop-dropdown');
        const selectedBusStopsContainer = document.getElementById('selected-busstops');
        const noBusStopsMessage = document.getElementById('no-busstops-message');
        const numDeparturesInput = document.getElementById('num-departures');
        const refreshIntervalInput = document.getElementById('refresh-interval');
        const darkModeToggle = document.getElementById('dark-mode');
        const saveSettingsButton = document.getElementById('save-settings');
        const stationsContainer = document.getElementById('stations-container');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');

        // Functions
        function updateClock() {
            const now = new Date();
            document.getElementById('clock').textContent =
                now.toLocaleTimeString('nl-NL', { hour: '2-digit', minute: '2-digit' });
        }

        function formatTime(dateTimeStr) {
            return new Date(dateTimeStr).toLocaleTimeString('nl-NL', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function formatDelayedTime(plannedTime, actualTime) {
            const planned = new Date(plannedTime);
            const actual = new Date(actualTime);
            const delayMinutes = Math.floor((actual - planned) / 60000);

            return `${formatTime(actual)} <small class="text-xs">+${delayMinutes}'</small>`;
        }

        // Clear input fields on page load
        window.addEventListener('load', () => {
            // Clear any autofilled values
            document.getElementById('station-search').value = '';
            document.getElementById('busstop-search').value = '';

            // Make sure all input elements have autocomplete disabled
            document.querySelectorAll('input[type="text"], input[type="number"]').forEach(input => {
                input.setAttribute('autocomplete', 'off');
            });
        });

        // Tab functionality
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.dataset.tab;

                // Remove active class from all tabs and contents
                tabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(c => c.classList.remove('active'));

                // Add active class to clicked tab and corresponding content
                tab.classList.add('active');
                document.getElementById(`${tabId}-tab`).classList.add('active');
            });
        });

        async function fetchStations() {
            try {
                const response = await fetch('stations-2023-09.csv');
                const csvText = await response.text();

                // Parse CSV
                const lines = csvText.split('\n');
                const headers = lines[0].split(',');

                const stations = [];
                for (let i = 1; i < lines.length; i++) {
                    if (!lines[i].trim()) continue;

                    const values = lines[i].split(',');
                    const station = {};

                    for (let j = 0; j < headers.length; j++) {
                        let value = values[j];
                        // Remove quotes if present
                        if (value && (value.startsWith('"') || value.startsWith("'"))) {
                            value = value.substring(1, value.length - 1);
                        }
                        station[headers[j]] = value;
                    }

                    stations.push(station);
                }

                allStations = stations;
                populateStationDropdown('');
            } catch (error) {
                console.error('Error fetching stations:', error);
            }
        }

        async function fetchBusStops() {
            try {
                // Disable the search input while loading
                busStopSearch.disabled = true;
                busStopSearch.placeholder = "Bushaltes worden geladen...";

                // Show loading indicator next to the search box
                const busSearchContainer = busStopSearch.parentElement;
                const loadingIndicator = document.createElement('span');
                loadingIndicator.id = 'bus-loading-indicator';
                loadingIndicator.className = 'ml-2 text-blue-500';
                loadingIndicator.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                busSearchContainer.appendChild(loadingIndicator);

                console.log('Fetching bus stops from local file...');
                const response = await fetch('bushaltes.xml');
                const xmlText = await response.text();
                console.log('XML received, length:', xmlText.length);

                // Log a snippet of the XML for debugging
                console.log('XML snippet:', xmlText.substring(0, 200) + '...');

                // Parse the XML using DOMParser
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, "text/xml");

                // Check if there was a parsing error
                const parserError = xmlDoc.querySelector('parsererror');
                if (parserError) {
                    console.error('XML parsing error:', parserError.textContent);
                    throw new Error('XML parsing error');
                }

                // Debug the XML structure
                const rootElement = xmlDoc.documentElement;
                console.log('Root element:', rootElement.tagName);

                // Get all bus stop nodes with a more explicit path
                const busStopNodes = xmlDoc.getElementsByTagName('bus_stop');
                console.log('Found bus stop nodes:', busStopNodes.length);

                // Create a temporary array to hold all bus stops
                const tempBusStops = [];

                // Convert NodeList to Array for easier debugging
                Array.from(busStopNodes).forEach((node, index) => {
                    try {
                        // More careful extraction with error handling
                        const quaycodeNode = node.getElementsByTagName('quaycode')[0];
                        const townNode = node.getElementsByTagName('town')[0];
                        const streetNode = node.getElementsByTagName('street')[0];

                        if (!quaycodeNode || !townNode || !streetNode) {
                            console.warn(`Missing required element in bus stop at index ${index}`);
                            return; // Skip this entry
                        }

                        const quaycode = quaycodeNode.textContent;
                        const town = townNode.textContent;
                        const street = streetNode.textContent;

                        // Create the name for the bus stop
                        const name = `${town}${street !== 'N/A' ? ', ' + street : ''}`;

                        tempBusStops.push({
                            code: quaycode,
                            town: town,
                            street: street !== 'N/A' ? street : '',
                            name: name,
                            displayName: name  // For displaying in UI
                        });
                    } catch (err) {
                        console.error(`Error processing bus stop at index ${index}:`, err);
                    }
                });

                console.log('Total bus stops before consolidation:', tempBusStops.length);

                // Consolidate bus stops with the same name
                const consolidatedBusStops = [];
                const busStopMap = new Map();

                tempBusStops.forEach(stop => {
                    const key = stop.name; // Use the name as a key for consolidation

                    if (busStopMap.has(key)) {
                        // This is a duplicate, add its quaycode to the existing entry
                        const existingStop = busStopMap.get(key);
                        if (!existingStop.allCodes) {
                            existingStop.allCodes = [existingStop.code];
                        }
                        existingStop.allCodes.push(stop.code);
                    } else {
                        // This is a new unique entry
                        busStopMap.set(key, stop);
                        consolidatedBusStops.push(stop);
                    }
                });

                console.log('Bus stops after consolidation:', consolidatedBusStops.length);
                console.log('Sample consolidated stops:', consolidatedBusStops.slice(0, 3));

                // Check for any stops with multiple codes
                const multiCodeStops = consolidatedBusStops.filter(stop => stop.allCodes && stop.allCodes.length > 1);
                if (multiCodeStops.length > 0) {
                    console.log('Stops with multiple quaycodes:', multiCodeStops.length);
                    console.log('Example:', multiCodeStops[0]);
                }

                allBusStops = consolidatedBusStops;

                // Only mark as loaded if we have bus stops
                if (consolidatedBusStops.length > 0) {
                    busStopsLoaded = true;

                    // Enable the search input now that data is loaded
                    busStopSearch.disabled = false;
                    busStopSearch.placeholder = "Typ om te zoeken...";
                } else {
                    console.error('No bus stops were loaded!');
                    busStopSearch.placeholder = "Geen bushaltes gevonden";

                    // Display a notification
                    const errorNotification = document.createElement('div');
                    errorNotification.className = 'p-2 mt-2 bg-red-100 text-red-800 rounded-md text-sm';
                    errorNotification.innerHTML = 'Er konden geen bushaltes worden geladen. Probeer de pagina te vernieuwen.';
                    busSearchContainer.parentNode.appendChild(errorNotification);
                }

                // Remove loading indicator
                const indicator = document.getElementById('bus-loading-indicator');
                if (indicator) {
                    indicator.remove();
                }

                return consolidatedBusStops;
            } catch (error) {
                console.error('Error fetching bus stops:', error);

                // Show error in search field
                busStopSearch.disabled = true;
                busStopSearch.placeholder = "Fout bij laden bushaltes";

                // Remove loading indicator
                const indicator = document.getElementById('bus-loading-indicator');
                if (indicator) {
                    indicator.remove();
                }

                return [];
            }
        }

        // Alternative method to load and parse the XML directly for fallback
        async function loadBusStopsWithFallback() {
            try {
                console.log('Trying fallback method to load bus stops...');

                // Hardcoded list of a few bus stops as fallback in case XML loading fails
                const fallbackData = [
                    { code: 'NL:Q:15005330', town: 'Assen', street: 'Leie' },
                    { code: 'NL:Q:64310190', town: 'Eersel', street: 'Dijk' },
                    { code: 'NL:Q:64310200', town: 'Eersel', street: 'Kerkstraat' },
                    { code: 'NL:Q:20630310', town: 'Hidaard', street: 'N/A' },
                    { code: 'NL:Q:20630300', town: 'Hidaard', street: 'N/A' },
                    { code: 'NL:Q:56230100', town: 'Hoofddorp', street: 'Deltaweg' },
                    { code: 'NL:Q:56230630', town: 'Hoofddorp', street: 'Deltaweg' },
                    { code: 'BE:Q:79640040', town: 'Knokke', street: 'Bayauxlaan' },
                    { code: 'NL:Q:61191400', town: 'Lent', street: 'N/A' },
                    { code: 'NL:Q:61191390', town: 'Lent', street: 'N/A' },
                    { code: 'NL:Q:13121110', town: 'Midwolda', street: 'Hoofdweg' }
                ];

                // Temporary array of all stops
                const tempBusStops = fallbackData.map(stop => ({
                    code: stop.code,
                    town: stop.town,
                    street: stop.street !== 'N/A' ? stop.street : '',
                    name: `${stop.town}${stop.street !== 'N/A' ? ', ' + stop.street : ''}`
                }));

                // Consolidate bus stops with the same name
                const consolidatedBusStops = [];
                const busStopMap = new Map();

                tempBusStops.forEach(stop => {
                    const key = stop.name; // Use the name as a key for consolidation

                    if (busStopMap.has(key)) {
                        // This is a duplicate, add its quaycode to the existing entry
                        const existingStop = busStopMap.get(key);
                        if (!existingStop.allCodes) {
                            existingStop.allCodes = [existingStop.code];
                        }
                        existingStop.allCodes.push(stop.code);
                    } else {
                        // This is a new unique entry
                        busStopMap.set(key, stop);
                        consolidatedBusStops.push(stop);
                    }
                });

                console.log('Loaded fallback bus stops:', consolidatedBusStops.length);
                allBusStops = consolidatedBusStops;
                busStopsLoaded = true;

                // Update UI
                busStopSearch.disabled = false;
                busStopSearch.placeholder = "Typ om te zoeken...";

                // Remove loading indicator
                const indicator = document.getElementById('bus-loading-indicator');
                if (indicator) {
                    indicator.remove();
                }

                return consolidatedBusStops;
            } catch (error) {
                console.error('Even fallback method failed:', error);
                return [];
            }
        }

        function populateStationDropdown(searchTerm) {
            stationDropdown.innerHTML = '';

            const filteredStations = allStations.filter(station =>
                station.name_long.toLowerCase().includes(searchTerm.toLowerCase()) ||
                station.code.toLowerCase().includes(searchTerm.toLowerCase())
            );

            filteredStations.forEach(station => {
                const stationItem = document.createElement('div');
                stationItem.className = 'station-item';
                stationItem.textContent = `${station.name_long} (${station.code})`;
                stationItem.dataset.code = station.code;
                stationItem.dataset.name = station.name_long;

                stationItem.addEventListener('click', () => {
                    addStation(station.code, station.name_long);
                    stationSearch.value = '';
                    stationDropdown.classList.remove('open');
                });

                stationDropdown.appendChild(stationItem);
            });

            if (filteredStations.length > 0) {
                stationDropdown.classList.add('open');
            } else {
                stationDropdown.classList.remove('open');
            }
        }

        function populateBusStopDropdown(searchTerm) {
            busStopDropdown.innerHTML = '';

            console.log('Searching for bus stops with term:', searchTerm);

            // Check if bus stops are loaded
            if (!busStopsLoaded) {
                console.log('Bus stops not loaded yet, showing message');
                const loadingMessage = document.createElement('div');
                loadingMessage.className = 'busstop-item text-gray-500 italic';
                loadingMessage.textContent = 'Bushaltes worden nog geladen...';
                busStopDropdown.appendChild(loadingMessage);
                busStopDropdown.classList.add('open');
                return;
            }

            console.log('Total bus stops available:', allBusStops.length);

            if (!searchTerm || searchTerm.length < 2) {
                busStopDropdown.classList.remove('open');
                return;
            }

            // Create a more flexible search by looking at town and street separately
            const filteredBusStops = allBusStops.filter(stop => {
                const townMatch = stop.town.toLowerCase().includes(searchTerm.toLowerCase());
                const streetMatch = stop.street && stop.street.toLowerCase().includes(searchTerm.toLowerCase());
                const fullNameMatch = stop.name.toLowerCase().includes(searchTerm.toLowerCase());
                const codeMatch = stop.code.toLowerCase().includes(searchTerm.toLowerCase());

                return townMatch || streetMatch || fullNameMatch || codeMatch;
            }).slice(0, 5); // Limit to max 5 results

            console.log('Filtered bus stops:', filteredBusStops.length);

            if (filteredBusStops.length > 0) {
                filteredBusStops.forEach(stop => {
                    const stopItem = document.createElement('div');
                    stopItem.className = 'busstop-item';
                    stopItem.textContent = `${stop.name} (${stop.code})`;
                    stopItem.dataset.code = stop.code;
                    stopItem.dataset.name = stop.name;

                    // If the stop has multiple codes, store them as a data attribute
                    if (stop.allCodes && stop.allCodes.length > 1) {
                        stopItem.dataset.allCodes = JSON.stringify(stop.allCodes);
                    }

                    stopItem.addEventListener('click', () => {
                        // Check if this stop has multiple quaycodes
                        const allCodes = stop.allCodes || [stop.code];

                        // Pass all codes to addBusStop
                        addBusStop(stop.code, stop.name, allCodes);
                        busStopSearch.value = '';
                        busStopDropdown.classList.remove('open');
                    });

                    busStopDropdown.appendChild(stopItem);
                });

                busStopDropdown.classList.add('open');
            } else {
                const noResults = document.createElement('div');
                noResults.className = 'busstop-item text-gray-500 italic';
                noResults.textContent = 'Geen resultaten gevonden';
                busStopDropdown.appendChild(noResults);
                busStopDropdown.classList.add('open');
            }
        }

        function addStation(code, name) {
            // Check if station is already selected
            if (selectedStations.some(station => station.code === code)) {
                return;
            }

            selectedStations.push({ code, name });
            updateSelectedStationsList();
            saveSettings();
        }

        function addBusStop(code, name, allCodes) {
            // Check if bus stop is already selected
            if (selectedBusStops.some(stop => stop.code === code)) {
                return;
            }

            selectedBusStops.push({
                code: code,
                name: name,
                allCodes: allCodes || [code] // Store all codes for consolidated stops
            });
            updateSelectedBusStopsList();
            saveSettings();
        }

        function removeStation(code) {
            selectedStations = selectedStations.filter(station => station.code !== code);
            updateSelectedStationsList();
            saveSettings();
        }

        function removeBusStop(code) {
            selectedBusStops = selectedBusStops.filter(stop => stop.code !== code);
            updateSelectedBusStopsList();
            saveSettings();
        }

        function updateSelectedStationsList() {
            selectedStationsContainer.innerHTML = '';

            if (selectedStations.length === 0) {
                selectedStationsContainer.appendChild(noStationsMessage);
                return;
            }

            selectedStations.forEach(station => {
                const stationElement = document.createElement('div');
                stationElement.className = 'selected-station';

                const nameSpan = document.createElement('span');
                nameSpan.textContent = `${station.name} (${station.code})`;

                const removeButton = document.createElement('button');
                removeButton.innerHTML = '<i class="fas fa-times"></i>';
                removeButton.addEventListener('click', () => removeStation(station.code));

                stationElement.appendChild(nameSpan);
                stationElement.appendChild(removeButton);
                selectedStationsContainer.appendChild(stationElement);
            });
        }

        function updateSelectedBusStopsList() {
            selectedBusStopsContainer.innerHTML = '';

            if (selectedBusStops.length === 0) {
                selectedBusStopsContainer.appendChild(noBusStopsMessage);
                return;
            }

            selectedBusStops.forEach(stop => {
                const stopElement = document.createElement('div');
                stopElement.className = 'selected-busstop';

                const nameSpan = document.createElement('span');
                nameSpan.textContent = `${stop.name} (${stop.code})`;

                const removeButton = document.createElement('button');
                removeButton.innerHTML = '<i class="fas fa-times"></i>';
                removeButton.addEventListener('click', () => removeBusStop(stop.code));

                stopElement.appendChild(nameSpan);
                stopElement.appendChild(removeButton);
                selectedBusStopsContainer.appendChild(stopElement);
            });
        }

        async function fetchAllDepartures() {
            stationsContainer.innerHTML = '';

            if (selectedStations.length === 0 && selectedBusStops.length === 0) {
                stationsContainer.innerHTML = '<div class="text-center p-8"><p class="text-gray-500">Geen stations of bushaltes geselecteerd. Gebruik de instellingen om stations/haltes toe te voegen.</p></div>';
                return;
            }

            // Fetch train departures
            const trainPromises = selectedStations.map(station => fetchTrainDepartures(station));

            // Fetch bus departures
            const busPromises = selectedBusStops.map(stop => fetchBusDepartures(stop));

            await Promise.all([...trainPromises, ...busPromises]);

            document.getElementById('last-update').textContent = new Date().toLocaleTimeString('nl-NL');
        }

        async function fetchTrainDepartures(station) {
            try {
                const response = await fetch(`https://gateway.apiportal.ns.nl/reisinformatie-api/api/v2/departures?station=${station.code}`, {
                    headers: {
                        'Ocp-Apim-Subscription-Key': 'e81b1ef0400449d6a124463525c0b782',
                        'Cache-Control': 'no-cache'
                    }
                });

                if (!response.ok) {
                    throw new Error(`Error fetching data for station ${station.code}: ${response.status}`);
                }

                const data = await response.json();
                updateTrainDeparturesCard(station, data.payload.departures);
            } catch (error) {
                console.error(`Error fetching train data for ${station.code}:`, error);
                createErrorCard(station, 'train');
            }
        }

        async function fetchBusDepartures(stop) {
            try {
                // Get all quaycodes for this stop
                const quaycodes = stop.allCodes || [stop.code];
                console.log(`Fetching bus departures for stop ${stop.name} with ${quaycodes.length} quaycodes:`, quaycodes);

                // Prepare an array to hold all departures from all quaycodes
                let allDepartures = [];

                // Create requests for each quaycode
                const requests = quaycodes.map(async quaycode => {
                    try {
                        // Process quaycode to remove the 'NL:Q:' prefix if present
                        const processedCode = quaycode.replace('NL:Q:', '');

                        // Use a CORS proxy to access the OVAPI
                        const response = await fetch(`https://api.allorigins.win/raw?url=http://v0.ovapi.nl/tpc/${processedCode}`);

                        if (!response.ok) {
                            console.warn(`Error fetching data for bus stop quaycode ${processedCode}: ${response.status}`);
                            return [];
                        }

                        const data = await response.json();
                        const stopData = data[processedCode];

                        if (!stopData || !stopData.Passes) {
                            console.warn(`No departure data for bus stop quaycode ${processedCode}`);
                            return [];
                        }

                        // Process the departures for this quaycode
                        const departures = Object.values(stopData.Passes)
                            .filter(pass => {
                                const departureTime = new Date(pass.ExpectedDepartureTime);
                                return departureTime > new Date();
                            })
                            .map(pass => {
                                const targetTime = new Date(pass.TargetDepartureTime);
                                const expectedTime = new Date(pass.ExpectedDepartureTime);
                                const isDelayed = expectedTime > targetTime;
                                const delayMinutes = isDelayed ?
                                    Math.round((expectedTime - targetTime) / 60000) : 0;
                                return {
                                    time: expectedTime,
                                    targetTime: targetTime,
                                    line: pass.LinePublicNumber,
                                    direction: pass.DestinationName50,
                                    operator: pass.OperatorCode.replace('BRAVO:', ''),
                                    isDelayed: isDelayed,
                                    delayMinutes: delayMinutes,
                                    quaycode: processedCode // Keep track of which quaycode this came from
                                };
                            });

                        console.log(`Found ${departures.length} departures for quaycode ${processedCode}`);
                        return departures;
                    } catch (error) {
                        console.error(`Error processing quaycode ${quaycode}:`, error);
                        return [];
                    }
                });

                // Wait for all requests to complete
                const departureArrays = await Promise.all(requests);

                // Combine all departures into a single array and sort by time
                departureArrays.forEach(departures => {
                    allDepartures = [...allDepartures, ...departures];
                });

                // Sort by departure time
                allDepartures.sort((a, b) => a.time - b.time);

                console.log(`Combined ${allDepartures.length} departures from all quaycodes for ${stop.name}`);

                // Update the UI with the combined departures
                updateBusDeparturesCard(stop, allDepartures);
            } catch (error) {
                console.error(`Error fetching bus data for ${stop.name}:`, error);
                createErrorCard(stop, 'bus');
            }
        }

        function createErrorCard(item, type) {
            const cardClass = type === 'train' ? 'station-card' : 'busstop-card';
            const icon = type === 'train' ? 'train' : 'bus';

            const card = document.createElement('div');
            card.className = `bg-white rounded-lg shadow-lg overflow-hidden ${cardClass}`;

            card.innerHTML = `
                <div class="p-4 bg-red-100 border-b border-red-200">
                    <h2 class="text-lg sm:text-xl font-bold text-red-800">
                        <i class="fas fa-${icon} mr-2"></i>
                        ${item.name} (${item.code})
                    </h2>
                </div>
                <div class="p-6 text-center">
                    <p class="text-red-600">Kon geen vertrektijden ophalen.</p>
                    <p class="text-gray-600 mt-2">Probeer het later opnieuw.</p>
                </div>
            `;

            stationsContainer.appendChild(card);
        }

        function updateTrainDeparturesCard(station, departures) {
            const stationCard = document.createElement('div');
            stationCard.className = 'bg-white rounded-lg shadow-lg overflow-hidden station-card';

            const headerHtml = `
                <div class="p-4 bg-blue-50 border-b border-blue-100 flex justify-between items-center">
                    <h2 class="text-lg sm:text-xl font-bold text-blue-900">
                        <i class="fas fa-train mr-2"></i>
                        ${station.name} (${station.code})
                    </h2>
                </div>
            `;

            let tableHtml = `
                <div class="overflow-x-auto">
                    <table class="w-full responsive-table">
                        <thead class="bg-blue-900 text-white">
                            <tr>
                                <th class="px-4 py-2 sm:px-6 sm:py-3 text-left">Tijd</th>
                                <th class="px-4 py-2 sm:px-6 sm:py-3 text-left">Bestemming</th>
                                <th class="px-4 py-2 sm:px-6 sm:py-3 text-left">Spoor</th>
                                <th class="px-4 py-2 sm:px-6 sm:py-3 text-left">Type</th>
                                <th class="px-4 py-2 sm:px-6 sm:py-3 text-left">Status</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            if (departures && departures.length > 0) {
                const limitedDepartures = departures.slice(0, numDepartures);

                limitedDepartures.forEach(train => {
                    const plannedTime = formatTime(train.plannedDateTime);
                    const actualTime = formatTime(train.actualDateTime);
                    const isDelayed = plannedTime !== actualTime && !train.cancelled;

                    tableHtml += `
                        <tr class="border-b hover:bg-gray-50 ${train.cancelled ? 'cancelled' : ''}">
                            <td class="${isDelayed ? 'delayed' : ''}" data-label="Tijd">
                                ${isDelayed ? formatDelayedTime(train.plannedDateTime, train.actualDateTime) : plannedTime}
                            </td>
                            <td data-label="Bestemming">${train.direction}</td>
                            <td data-label="Spoor" class="font-mono">${train.actualTrack || train.plannedTrack || '-'}</td>
                            <td data-label="Type">${train.product.shortCategoryName || train.product.categoryCode}</td>
                            <td data-label="Status">
                                ${train.cancelled ? '<span class="text-red-600">Geannuleerd</span>' :
                            train.messages && train.messages.length > 0 ? `<span class="text-yellow-600">${train.messages[0].message}</span>` :
                                isDelayed ? '<span class="text-red-600">Vertraagd</span>' :
                                    '<span class="text-green-600">Op tijd</span>'}
                            </td>
                        </tr>
                    `;
                });
            } else {
                tableHtml += `
                    <tr>
                        <td colspan="5" class="px-4 py-4 text-center text-gray-500">
                            Geen vertrektijden beschikbaar voor dit station.
                        </td>
                    </tr>
                `;
            }

            tableHtml += `
                        </tbody>
                    </table>
                </div>
            `;

            stationCard.innerHTML = headerHtml + tableHtml;
            stationsContainer.appendChild(stationCard);
        }

        function updateBusDeparturesCard(stop, departures) {
            const busStopCard = document.createElement('div');
            busStopCard.className = 'bg-white rounded-lg shadow-lg overflow-hidden busstop-card';

            // Show number of quaycodes if there are multiple
            const multipleQuaycodes = stop.allCodes && stop.allCodes.length > 1;
            const quaycodeInfo = multipleQuaycodes ?
                `<span class="text-xs text-gray-500 ml-2">(${stop.allCodes.length} perrons)</span>` : '';

            const headerHtml = `
                <div class="p-4 bg-orange-50 border-b border-orange-100 flex justify-between items-center">
                    <h2 class="text-lg sm:text-xl font-bold text-orange-800">
                        <i class="fas fa-bus mr-2"></i>
                        ${stop.name} ${quaycodeInfo}
                    </h2>
                </div>
            `;

            let tableHtml = `
                <div class="overflow-x-auto">
                    <table class="w-full responsive-table">
                        <thead class="bus-orange">
                            <tr>
                                <th class="px-4 py-2 sm:px-6 sm:py-3 text-left">Tijd</th>
                                <th class="px-4 py-2 sm:px-6 sm:py-3 text-left">Lijn</th>
                                <th class="px-4 py-2 sm:px-6 sm:py-3 text-left">Bestemming</th>
                                <th class="px-4 py-2 sm:px-6 sm:py-3 text-left">Vervoerder</th>
                                <th class="px-4 py-2 sm:px-6 sm:py-3 text-left">Status</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            if (departures && departures.length > 0) {
                const limitedDepartures = departures.slice(0, numDepartures);

                limitedDepartures.forEach(bus => {
                    tableHtml += `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="${bus.isDelayed ? 'delayed' : ''}" data-label="Tijd">
                                ${bus.isDelayed ?
                            `${formatTime(bus.time)} <small class="text-xs">+${bus.delayMinutes}'</small>` :
                            formatTime(bus.time)}
                            </td>
                            <td data-label="Lijn" class="font-mono font-bold">${bus.line}</td>
                            <td data-label="Bestemming">${bus.direction}</td>
                            <td data-label="Vervoerder">${bus.operator}</td>
                            <td data-label="Status">
                                ${bus.isDelayed ?
                            '<span class="text-red-600">Vertraagd</span>' :
                            '<span class="text-green-600">Op tijd</span>'}
                            </td>
                        </tr>
                    `;
                });
            } else {
                tableHtml += `
                    <tr>
                        <td colspan="5" class="px-4 py-4 text-center text-gray-500">
                            Geen vertrektijden beschikbaar voor deze bushalte.
                        </td>
                    </tr>
                `;
            }

            tableHtml += `
                        </tbody>
                    </table>
                </div>
            `;

            busStopCard.innerHTML = headerHtml + tableHtml;
            stationsContainer.appendChild(busStopCard);
        }

        function saveSettings() {
            const settings = {
                selectedStations,
                selectedBusStops,
                numDepartures: parseInt(numDeparturesInput.value),
                refreshInterval: parseInt(refreshIntervalInput.value),
                darkMode: darkModeToggle.checked
            };

            localStorage.setItem('ovSettings', JSON.stringify(settings));

            // Apply settings
            numDepartures = settings.numDepartures;
            refreshInterval = settings.refreshInterval;

            // Update refresh timer
            clearInterval(refreshTimer);
            refreshTimer = setInterval(fetchAllDepartures, refreshInterval * 1000);

            // Apply dark mode
            if (settings.darkMode) {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }

            // Refresh departures
            fetchAllDepartures();
        }

        function loadSettings() {
            const savedSettings = localStorage.getItem('ovSettings');

            if (savedSettings) {
                const settings = JSON.parse(savedSettings);

                selectedStations = settings.selectedStations || [];
                selectedBusStops = settings.selectedBusStops || [];
                numDepartures = settings.numDepartures || DEFAULT_DEPARTURES;
                refreshInterval = settings.refreshInterval || 30;

                // Update UI
                numDeparturesInput.value = numDepartures;
                refreshIntervalInput.value = refreshInterval;
                darkModeToggle.checked = settings.darkMode || false;

                // Check for dark mode on page load
                if (settings.darkMode) {
                    document.body.classList.add('dark-mode');
                }

                updateSelectedStationsList();
                updateSelectedBusStopsList();
            }
        }

        // Event Listeners
        settingsToggle.addEventListener('click', () => {
            settingsPanel.classList.add('open');
            settingsOverlay.classList.add('open');
        });

        closeSettings.addEventListener('click', () => {
            settingsPanel.classList.remove('open');
            settingsOverlay.classList.remove('open');
        });

        settingsOverlay.addEventListener('click', () => {
            settingsPanel.classList.remove('open');
            settingsOverlay.classList.remove('open');
        });

        stationSearch.addEventListener('input', (e) => {
            populateStationDropdown(e.target.value);
        });

        stationSearch.addEventListener('focus', () => {
            if (stationSearch.value) {
                stationDropdown.classList.add('open');
            }
        });

        busStopSearch.addEventListener('input', (e) => {
            const searchTerm = e.target.value.trim();
            console.log('Bus stop search input:', searchTerm);

            // Only search if bus stops are loaded
            if (busStopsLoaded) {
                populateBusStopDropdown(searchTerm);
            } else {
                console.log('Bus stops not loaded yet, cannot search');
                // Show a message to the user
                busStopDropdown.innerHTML = '';
                const loadingMessage = document.createElement('div');
                loadingMessage.className = 'busstop-item text-gray-500 italic';
                loadingMessage.textContent = 'Bushaltes worden nog geladen...';
                busStopDropdown.appendChild(loadingMessage);
                busStopDropdown.classList.add('open');
            }
        });

        busStopSearch.addEventListener('focus', () => {
            const searchTerm = busStopSearch.value.trim();
            console.log('Bus stop search focus, current value:', searchTerm);

            // Only search if bus stops are loaded
            if (busStopsLoaded) {
                if (searchTerm && searchTerm.length >= 2) {
                    populateBusStopDropdown(searchTerm);
                }
            } else {
                console.log('Bus stops not loaded yet, showing loading message');
                // Show a message to the user
                busStopDropdown.innerHTML = '';
                const loadingMessage = document.createElement('div');
                loadingMessage.className = 'busstop-item text-gray-500 italic';
                loadingMessage.textContent = 'Bushaltes worden nog geladen...';
                busStopDropdown.appendChild(loadingMessage);
                busStopDropdown.classList.add('open');
            }
        });

        document.addEventListener('click', (e) => {
            if (!stationSearch.contains(e.target) && !stationDropdown.contains(e.target)) {
                stationDropdown.classList.remove('open');
            }
            if (!busStopSearch.contains(e.target) && !busStopDropdown.contains(e.target)) {
                busStopDropdown.classList.remove('open');
            }
        });

        saveSettingsButton.addEventListener('click', () => {
            saveSettings();
            settingsPanel.classList.remove('open');
            settingsOverlay.classList.remove('open');
        });

        // Initialize
        updateClock();

        // Make sure bus stops are loaded before attempting to show anything
        fetchBusStops().then(busStops => {
            console.log('Bus stops loading completed with', busStops.length, 'stops');

            // If no bus stops were loaded, try the fallback method
            if (busStops.length === 0) {
                console.warn('Primary method failed to load bus stops, trying fallback method...');
                return loadBusStopsWithFallback();
            }

            return busStops;
        }).then(busStops => {
            console.log('Final bus stops count:', busStops.length);
            return fetchStations();
        }).then(() => {
            console.log('Train stations loaded successfully');
            loadSettings();
            fetchAllDepartures();
        }).catch(error => {
            console.error('Error during initialization:', error);
            // Try fallback even on error
            loadBusStopsWithFallback().then(() => {
                return fetchStations();
            }).then(() => {
                loadSettings();
                fetchAllDepartures();
            }).catch(finalError => {
                console.error('All attempts failed:', finalError);
            });
        });

        // Update clock every second
        setInterval(updateClock, 1000);

        // Set up refresh timer
        refreshTimer = setInterval(fetchAllDepartures, refreshInterval * 1000);
    </script>
</body>

</html>
