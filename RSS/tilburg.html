<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Meldingen voor Tilburg</title>
  <style>
    /* Algemeen */
    body {
      margin: 0;
      padding: 0;
      font-family: "Helvetica Neue", Arial, sans-serif;
      background-color: #f2f2f2;
      color: #333;
      line-height: 1.5;
    }

    /* Container */
    #container {
      max-width: 600px;
      margin: 0 auto;
      padding: 0 1rem;
    }

    header {
      background-color: #0055a5;
      color: #fff;
      padding: 1.5rem 1rem;
      text-align: center;
      border-bottom: 4px solid #003f7f;
    }

    header h1 {
      margin: 0;
      font-size: 1.5rem;
    }

    /* Meldingenlijst */
    #alerts {
      margin-top: 1rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      padding-bottom: 2rem;
    }

    .alert-card {
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .alert-card header {
      background-color: #003f7f;
      color: #fff;
      padding: 0.75rem 1rem;
    }

    .alert-card header h2 {
      margin: 0;
      font-size: 1.1rem;
      line-height: 1.3;
    }

    .alert-card .body {
      padding: 1rem;
    }

    .alert-card .body p {
      margin: 0.5rem 0;
    }

    .alert-card .body a {
      display: inline-block;
      margin-top: 0.75rem;
      text-decoration: none;
      color: #0055a5;
      font-weight: bold;
    }

    .alert-card .body a:hover {
      text-decoration: underline;
    }

    /* Spinner / Laden-indicator */
    .loader {
      margin: 2rem auto;
      border: 6px solid #e0e0e0;
      border-top: 6px solid #0055a5;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* Foutmelding */
    .error {
      margin: 2rem 0;
      text-align: center;
      color: #aa0000;
      font-weight: bold;
    }

    /* Responsief: mobiele schaling van titels */
    @media (max-width: 400px) {
      header h1 {
        font-size: 1.25rem;
      }
      .alert-card header h2 {
        font-size: 1rem;
      }
    }
  </style>
</head>
<body>
  <div id="container">
    <header>
      <h1>Meldingen voor Tilburg</h1>
    </header>

    <div id="alerts">
      <!-- Hier verschijnen de meldingen of de loader / foutmelding -->
      <div class="loader" id="loader"></div>
    </div>
  </div>

  <script>
    (function () {
      const RSS_URL = "https://www.alarmeringen.nl/feeds/region/midden-en-west-brabant.rss";
      const alertsContainer = document.getElementById("alerts");
      const loader = document.getElementById("loader");

      /**
       * Functie om teksten (Titel/Beschrijving) te ontsmetten als plain text,
       * zodat eventuele HTML-tags uit de RSS niet ongehinderd in de pagina verschijnen.
       */
      function sanitizeText(s) {
        const tempDiv = document.createElement("div");
        tempDiv.textContent = s;
        return tempDiv.innerHTML;
      }

      /**
       * Functie om een HTML-element voor één melding te maken en toe te voegen.
       * @param {Object} item Een object met { title, description, link, pubDate }.
       */
      function renderAlert(item) {
        // Alert card
        const card = document.createElement("article");
        card.className = "alert-card";

        // Header met titel
        const header = document.createElement("header");
        const titleEl = document.createElement("h2");
        titleEl.innerHTML = sanitizeText(item.title);
        header.appendChild(titleEl);
        card.appendChild(header);

        // Body met datum, beschrijving en link
        const body = document.createElement("div");
        body.className = "body";

        // Publicatiedatum
        if (item.pubDate) {
          const dateEl = document.createElement("p");
          const date = new Date(item.pubDate);
          // Format: DD-MM-YYYY om begrijpelijk te maken
          const formatted =
            String(date.getDate()).padStart(2, "0") +
            "-" +
            String(date.getMonth() + 1).padStart(2, "0") +
            "-" +
            date.getFullYear() +
            " " +
            String(date.getHours()).padStart(2, "0") +
            ":" +
            String(date.getMinutes()).padStart(2, "0");
          dateEl.textContent = "Gepubliceerd: " + formatted;
          body.appendChild(dateEl);
        }

        // Beschrijving
        if (item.description) {
          const descEl = document.createElement("p");
          descEl.innerHTML = sanitizeText(item.description);
          body.appendChild(descEl);
        }

        // Link naar detailpagina
        if (item.link) {
          const linkEl = document.createElement("a");
          linkEl.href = item.link;
          linkEl.textContent = "Meer info";
          linkEl.target = "_blank";
          body.appendChild(linkEl);
        }

        card.appendChild(body);
        alertsContainer.appendChild(card);
      }

      /**
       * Haalt het RSS-feed op, parseert de XML, filtert op "Tilburg" en rendert de meldingen.
       */
      async function fetchAndDisplay() {
        try {
          const response = await fetch(RSS_URL);
          if (!response.ok) {
            throw new Error("Kon de feed niet laden (status " + response.status + ")");
          }

          const xmlText = await response.text();
          const parser = new DOMParser();
          const xmlDoc = parser.parseFromString(xmlText, "application/xml");

          // Error-checking bij ongeldige XML
          const parserError = xmlDoc.querySelector("parsererror");
          if (parserError) {
            throw new Error("Fout bij het parsen van de RSS-feed.");
          }

          // Alle <item>-elementen in de feed
          const items = Array.from(xmlDoc.querySelectorAll("item"));
          // Filter: enkel items die "Tilburg" bevatten in titel of beschrijving
          const filtered = items.filter((it) => {
            const title = it.querySelector("title")?.textContent || "";
            const desc = it.querySelector("description")?.textContent || "";
            // gebruik een case-insensitive match op woordgrens Tilburg
            const pattern = /\bTilburg\b/i;
            return pattern.test(title) || pattern.test(desc);
          });

          // Opruimen: loader verwijderen
          loader.remove();

          if (filtered.length === 0) {
            const noEl = document.createElement("p");
            noEl.textContent = "Geen meldingen gevonden voor Tilburg.";
            noEl.style.textAlign = "center";
            noEl.style.marginTop = "2rem";
            alertsContainer.appendChild(noEl);
            return;
          }

          // Per gefilterde melding: renderen
          filtered.forEach((it) => {
            const title = it.querySelector("title")?.textContent || "Geen titel";
            const description = it.querySelector("description")?.textContent || "";
            const link = it.querySelector("link")?.textContent || "";
            const pubDate = it.querySelector("pubDate")?.textContent || "";

            renderAlert({
              title: title,
              description: description,
              link: link,
              pubDate: pubDate,
            });
          });
        } catch (error) {
          loader.remove();
          const errorEl = document.createElement("div");
          errorEl.className = "error";
          errorEl.textContent = "Er is een fout opgetreden: " + error.message;
          alertsContainer.appendChild(errorEl);
          console.error("Fout bij fetchAndDisplay:", error);
        }
      }

      // Start het ophalen zodra de pagina geladen is
      document.addEventListener("DOMContentLoaded", fetchAndDisplay);
    })();
  </script>
</body>
</html>